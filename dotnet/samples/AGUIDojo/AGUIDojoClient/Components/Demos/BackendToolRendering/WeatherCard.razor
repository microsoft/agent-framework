@* Copyright (c) Microsoft. All rights reserved. *@
@using AGUIDojoClient.Components.Shared
@using Microsoft.AspNetCore.Components.AI

@if (Weather is null)
{
    <div class="weather-card weather-loading">
        <div class="weather-header">
            <div class="weather-location">
                <h3>@Location</h3>
                <p>Loading weather...</p>
            </div>
            <span class="weather-icon skeleton-icon"></span>
        </div>
        
        <div class="weather-main">
            <div class="temperature">
                <span class="temp-value skeleton-text skeleton-temp"></span>
                <span class="temp-fahrenheit skeleton-text skeleton-temp-f"></span>
            </div>
            <div class="conditions skeleton-text skeleton-conditions"></div>
        </div>
        
        <div class="weather-details">
            <div class="detail-item">
                <p class="detail-label">Humidity</p>
                <p class="detail-value skeleton-text skeleton-detail"></p>
            </div>
            <div class="detail-item">
                <p class="detail-label">Wind</p>
                <p class="detail-value skeleton-text skeleton-detail"></p>
            </div>
            <div class="detail-item">
                <p class="detail-label">Feels Like</p>
                <p class="detail-value skeleton-text skeleton-detail"></p>
            </div>
        </div>
    </div>
}
else
{
    <div class="weather-card @GetConditionClass()">
        <div class="weather-header">
            <div class="weather-location">
                <h3>@Location</h3>
                <p>Current Weather</p>
            </div>
            <span class="weather-icon">@Weather.ConditionIcon</span>
        </div>
        
        <div class="weather-main">
            <div class="temperature">
                <span class="temp-value">@Weather.Temperature° C</span>
                <span class="temp-fahrenheit">/ @Weather.TemperatureFahrenheit.ToString("F1")° F</span>
            </div>
            <div class="conditions">@Weather.Conditions</div>
        </div>
        
        <div class="weather-details">
            <div class="detail-item">
                <p class="detail-label">Humidity</p>
                <p class="detail-value">@(Weather.Humidity)%</p>
            </div>
            <div class="detail-item">
                <p class="detail-label">Wind</p>
                <p class="detail-value">@Weather.WindSpeed mph</p>
            </div>
            <div class="detail-item">
                <p class="detail-label">Feels Like</p>
                <p class="detail-value">@(Weather.FeelsLike)°</p>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    public InvocationContext Invocation { get; set; } = default!;

    private string Location => Invocation?.GetArgument<string>("location") ?? "Unknown Location";

    private WeatherInfo? Weather => Invocation?.HasResult == true 
        ? Invocation.GetResult<WeatherInfo>() 
        : null;

    protected override void OnInitialized()
    {
        if (Invocation is not null && !Invocation.HasResult)
        {
            Invocation.ResultArrived += OnResultArrived;
        }
    }

    private void OnResultArrived()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetConditionClass()
    {
        if (Weather is null)
        {
            return "condition-default";
        }

        return Weather.Conditions.ToLowerInvariant() switch
        {
            "sunny" or "clear" => "condition-sunny",
            "cloudy" or "overcast" => "condition-cloudy",
            "rainy" or "rain" => "condition-rainy",
            "stormy" or "thunderstorm" => "condition-stormy",
            "snowy" or "snow" => "condition-snowy",
            "foggy" or "fog" => "condition-foggy",
            _ => "condition-default"
        };
    }
}
