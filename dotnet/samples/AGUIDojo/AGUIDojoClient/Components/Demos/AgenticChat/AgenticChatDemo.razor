@* Copyright (c) Microsoft. All rights reserved. *@
@using Microsoft.AspNetCore.Components.AI
@using Microsoft.Agents.AI
@using Microsoft.Extensions.AI
@using Microsoft.Extensions.DependencyInjection
@using AGUIDojoClient.Services
@inject IServiceProvider ServiceProvider
@inject IBackgroundColorService BackgroundColorService
@implements IDisposable

<PageTitle>Agentic Chat</PageTitle>

<div class="chat-layout" style="@GetBackgroundStyle()">
    <div class="chat-header">
        <div class="chat-title">AGUI WebChat</div>
        <button class="new-chat-button" @onclick="ResetConversationAsync">
            <span class="button-icon">+</span> New chat
        </button>
    </div>

    <AgentBoundary Agent="@agent">
        <div class="chat-content">
            <Messages />
        </div>
        
        <div class="chat-input-container">
            <AgentSuggestions Suggestions="@suggestions" />
            <AgentInput Placeholder="Type your message..." />
        </div>
    </AgentBoundary>
</div>

@code {
    private AIAgent? agent;
    private string? _backgroundColor;
    private Suggestion[] suggestions = [
        new Suggestion("Change background", new ChatMessage(ChatRole.User, "Change background to light blue")),
        new Suggestion("Generate sonnet")
    ];

    [Parameter]
    public string ScenarioId { get; set; } = "agentic_chat";

    protected override void OnInitialized()
    {
        agent = ServiceProvider.GetRequiredKeyedService<AIAgent>("agentic-chat");
        BackgroundColorService.ColorChanged += OnColorChanged;
    }

    private string GetBackgroundStyle()
    {
        return _backgroundColor != null ? $"background-color: {_backgroundColor}" : "";
    }

    private async void OnColorChanged(object? sender, BackgroundColorChangedEventArgs e)
    {
        _backgroundColor = e.Color;
        await InvokeAsync(StateHasChanged);
    }

    private void ResetConversationAsync()
    {
        // Reset would need to be implemented in AgentBoundary
        StateHasChanged();
    }

    public void Dispose()
    {
        BackgroundColorService.ColorChanged -= OnColorChanged;
    }
}
