<Project>

  <!-- Detect incompatible TFM BEFORE importing SDK -->
  <PropertyGroup Condition="'$(TargetFramework)' != '' AND '$(TargetFramework)' != 'netstandard2.0'">
    <_SkipIncompatibleBuild>true</_SkipIncompatibleBuild>
    <!-- Skip ResolvePackageAssets which causes NETSDK1005 - must be set before SDK import -->
    <SkipResolvePackageAssets>true</SkipResolvePackageAssets>
  </PropertyGroup>

  <!-- Import SDK props -->
  <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk" />

  <!-- Source generators MUST target netstandard2.0 only -->
  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <TargetFrameworks>netstandard2.0</TargetFrameworks>
  </PropertyGroup>

  <!-- Skip build settings for incompatible TFM -->
  <PropertyGroup Condition="'$(_SkipIncompatibleBuild)' == 'true'">
    <EnableDefaultItems>false</EnableDefaultItems>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <DisableImplicitFrameworkReferences>true</DisableImplicitFrameworkReferences>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <GenerateTargetFrameworkAttribute>false</GenerateTargetFrameworkAttribute>
  </PropertyGroup>

  <PropertyGroup Condition="'$(_SkipIncompatibleBuild)' != 'true'">
    <LangVersion>latest</LangVersion>
    <Nullable>enable</Nullable>

    <!-- Enable C# 9 records support on netstandard2.0 -->
    <InjectIsExternalInitOnLegacy>true</InjectIsExternalInitOnLegacy>

    <!-- Source generator specific settings -->
    <IsRoslynComponent>true</IsRoslynComponent>
    <EnforceExtendedAnalyzerRules>true</EnforceExtendedAnalyzerRules>

    <!-- Place build output in analyzers folder for NuGet package -->
    <IncludeBuildOutput>true</IncludeBuildOutput>
    <BuildOutputTargetFolder>analyzers/dotnet/cs</BuildOutputTargetFolder>
    <SuppressDependenciesWhenPacking>true</SuppressDependenciesWhenPacking>

    <!-- Suppress nullable warnings for netstandard2.0 -->
    <NoWarn>$(NoWarn);nullable</NoWarn>
    <!-- Suppress analyzer release tracking requirement for source generators -->
    <NoWarn>$(NoWarn);RS2008</NoWarn>
  </PropertyGroup>

  <PropertyGroup>
    <VersionSuffix>preview</VersionSuffix>
  </PropertyGroup>

  <Import Project="$(RepoRoot)/dotnet/nuget/nuget-package.props" />

  <PropertyGroup>
    <!-- NuGet Package Settings -->
    <Title>Microsoft Agent Framework Workflows Source Generators</Title>
    <Description>Provides Roslyn source generators for Microsoft Agent Framework Workflows, enabling compile-time route configuration for executors.</Description>
    <DevelopmentDependency>true</DevelopmentDependency>
  </PropertyGroup>

  <ItemGroup Condition="'$(_SkipIncompatibleBuild)' != 'true'">
    <PackageReference Include="Microsoft.CodeAnalysis.CSharp" PrivateAssets="all" />
    <PackageReference Include="Microsoft.CodeAnalysis.Analyzers" PrivateAssets="all" />
  </ItemGroup>

  <!-- Import SDK targets -->
  <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk" />

  <!-- Skip incompatible TFM builds by setting property that SDK checks -->
  <PropertyGroup Condition="'$(_SkipIncompatibleBuild)' == 'true'">
    <!-- This tells the SDK to skip the ResolvePackageAssets check -->
    <SkipResolvePackageAssets>true</SkipResolvePackageAssets>
    <ResolvePackageAssets>false</ResolvePackageAssets>
    <!-- Make project.assets.json check pass by pretending we have it -->
    <ProjectAssetsFile></ProjectAssetsFile>
    <RestoreSuccess>true</RestoreSuccess>
    <!-- Skip copy to output directory -->
    <SkipCopyBuildProduct>true</SkipCopyBuildProduct>
    <CopyBuildOutputToOutputDirectory>false</CopyBuildOutputToOutputDirectory>
    <CopyOutputSymbolsToOutputDirectory>false</CopyOutputSymbolsToOutputDirectory>
  </PropertyGroup>

  <!-- Override Core targets for incompatible TFM -->
  <Target Name="CoreCompile" Condition="'$(_SkipIncompatibleBuild)' == 'true'">
    <Message Importance="high" Text="Skipping $(MSBuildProjectName) - TFM $(TargetFramework) is not supported (requires netstandard2.0)" />
  </Target>

  <Target Name="CreateManifestResourceNames" Condition="'$(_SkipIncompatibleBuild)' == 'true'" />

  <!-- Skip file copy operations for incompatible TFM -->
  <Target Name="CopyFilesToOutputDirectory" Condition="'$(_SkipIncompatibleBuild)' == 'true'" />

</Project>
