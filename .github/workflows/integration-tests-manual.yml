#
# This workflow allows manually running integration tests against an open PR.
# Go to Actions → "Integration Tests (Manual)" → Run workflow → enter the PR number.
#
# It reuses the existing dotnet-build-and-test and python-merge-tests workflows,
# passing a PR ref so they check out and test the PR code.
#

name: Integration Tests (Manual)

on:
  workflow_dispatch:
    inputs:
      pr-number:
        description: "PR number to run integration tests against"
        required: true
        type: string

permissions:
  contents: read
  pull-requests: read
  id-token: write

concurrency:
  group: integration-tests-manual-pr-${{ github.event.inputs.pr-number }}
  cancel-in-progress: true

jobs:
  resolve-pr:
    name: Resolve PR
    runs-on: ubuntu-latest
    outputs:
      checkout-ref: ${{ steps.pr-info.outputs.checkout-ref }}
    steps:
      - name: Get PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER='${{ github.event.inputs.pr-number }}'

          if ! echo "$PR_NUMBER" | grep -Eq '^[0-9]+$'; then
            echo "::error::Invalid PR number '$PR_NUMBER'. Only numeric values are allowed."
            exit 1
          fi

          PR_DATA=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json state,headRepository,headRepositoryOwner)
          PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
          HEAD_OWNER=$(echo "$PR_DATA" | jq -r '.headRepositoryOwner.login')
          REPO_OWNER="${{ github.repository_owner }}"

          if [ "$PR_STATE" != "OPEN" ]; then
            echo "::error::PR #$PR_NUMBER is not open (state: $PR_STATE)"
            exit 1
          fi

          if [ "$HEAD_OWNER" != "$REPO_OWNER" ]; then
            echo "::error::PR #$PR_NUMBER is from a fork ($HEAD_OWNER). Running integration tests against fork PRs is not allowed for security reasons."
            exit 1
          fi

          echo "checkout-ref=refs/pull/$PR_NUMBER/head" >> "$GITHUB_OUTPUT"
          echo "Running integration tests for PR #$PR_NUMBER"

  dotnet-integration-tests:
    name: .NET Integration Tests
    needs: resolve-pr
    uses: ./.github/workflows/dotnet-build-and-test.yml
    with:
      checkout-ref: ${{ needs.resolve-pr.outputs.checkout-ref }}
    secrets: inherit

  python-integration-tests:
    name: Python Integration Tests
    needs: resolve-pr
    uses: ./.github/workflows/python-merge-tests.yml
    with:
      checkout-ref: ${{ needs.resolve-pr.outputs.checkout-ref }}
    secrets: inherit
